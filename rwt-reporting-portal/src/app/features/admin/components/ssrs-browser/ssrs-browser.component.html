<cds-modal
  [open]="open"
  size="lg"
  (overlaySelected)="closeModal()">

  <cds-modal-header (closeSelect)="closeModal()">
    <p cdsModalHeaderLabel>SSRS Report Server</p>
    <p cdsModalHeaderHeading>Browse Reports</p>
  </cds-modal-header>

  <section cdsModalContent class="browser-content" (open)="onModalOpen()">
    <!-- Toolbar with breadcrumb and actions -->
    <div class="browser-toolbar">
      <nav class="breadcrumb-nav" aria-label="Folder navigation">
        <ol class="breadcrumb-list">
          <li *ngFor="let crumb of breadcrumbs; let last = last; let i = index" class="breadcrumb-item">
            <button
              *ngIf="!last"
              class="breadcrumb-link"
              (click)="navigateToBreadcrumb(crumb)"
              [attr.aria-current]="null">
              {{ crumb.name }}
            </button>
            <span *ngIf="last" class="breadcrumb-current" aria-current="page">
              {{ crumb.name }}
            </span>
            <span *ngIf="!last" class="breadcrumb-separator" aria-hidden="true">/</span>
          </li>
        </ol>
      </nav>

      <button cdsButton="ghost" size="sm" (click)="refresh()" [disabled]="isLoading">
        <svg cdsIcon="renew" size="16"></svg>
        Refresh
      </button>
    </div>

    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-container">
      <cds-loading [isActive]="true" size="normal" [overlay]="false"></cds-loading>
      <p class="loading-text">Loading SSRS content...</p>
    </div>

    <!-- Error state -->
    <div *ngIf="errorMessage && !isLoading" class="error-container" role="alert">
      <div class="error-content">
        <svg cdsIcon="warning--filled" size="20" class="error-icon"></svg>
        <div class="error-text">
          <strong>Connection Error</strong>
          <p>{{ errorMessage }}</p>
        </div>
      </div>
    </div>

    <!-- Browser panels -->
    <div *ngIf="!isLoading && !errorMessage" class="browser-panels">
      <!-- Folders panel with TreeView -->
      <div class="panel folders-panel">
        <div class="panel-header">
          <h4 class="panel-title">
            <svg cdsIcon="folder" size="16"></svg>
            Folders
          </h4>
        </div>
        <div class="panel-content">
          <cds-tree-view
            *ngIf="folderTree.length > 0"
            [tree]="folderTree"
            [label]="'Folder Navigation'"
            size="sm"
            (select)="onTreeNodeSelect($event)">
          </cds-tree-view>

          <div *ngIf="folderTree.length === 0 && currentPath === '/'" class="empty-state">
            <svg cdsIcon="folder" size="24" class="empty-icon"></svg>
            <p>No folders found</p>
          </div>
        </div>
      </div>

      <!-- Reports panel -->
      <div class="panel reports-panel">
        <div class="panel-header">
          <h4 class="panel-title">
            <svg cdsIcon="report" size="16"></svg>
            Reports in {{ getCurrentFolderName() }}
          </h4>
          <span class="report-count" *ngIf="reports.length > 0">{{ reports.length }} report(s)</span>
        </div>
        <div class="panel-content">
          <ul class="report-list" role="listbox" aria-label="Available reports">
            <li
              *ngFor="let report of reports"
              class="report-item"
              [class.report-item--selected]="selectedReport?.path === report.path"
              role="option"
              [attr.aria-selected]="selectedReport?.path === report.path"
              tabindex="0"
              (click)="selectReport(report)"
              (keydown.enter)="selectReport(report)"
              (keydown.space)="selectReport(report); $event.preventDefault()">
              <div class="report-icon">
                <svg cdsIcon="document" size="16"></svg>
              </div>
              <div class="report-info">
                <span class="report-name">{{ report.name }}</span>
                <span *ngIf="report.description" class="report-description">
                  {{ report.description }}
                </span>
              </div>
              <div class="report-indicator" *ngIf="selectedReport?.path === report.path">
                <svg cdsIcon="checkmark" size="16"></svg>
              </div>
            </li>
          </ul>

          <div *ngIf="reports.length === 0" class="empty-state">
            <svg cdsIcon="document" size="24" class="empty-icon"></svg>
            <p>No reports in this folder</p>
            <span class="empty-hint">Select a folder to view its reports</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Selection preview -->
    <div *ngIf="selectedReport" class="selection-preview">
      <div class="selection-icon">
        <svg cdsIcon="document" size="16"></svg>
      </div>
      <div class="selection-info">
        <span class="selection-label">Selected Report</span>
        <span class="selection-path">{{ selectedReport.path }}</span>
      </div>
    </div>
  </section>

  <cds-modal-footer>
    <button cdsButton="secondary" (click)="closeModal()">Cancel</button>
    <button
      cdsButton="primary"
      (click)="confirmSelection()"
      [disabled]="!selectedReport">
      Select Report
    </button>
  </cds-modal-footer>

</cds-modal>
